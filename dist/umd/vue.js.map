{"version":3,"file":"vue.js","sources":["../../src/util/index.js","../../src/effect.js","../../src/reactive.js","../../src/ref.js"],"sourcesContent":["/**\n * 判断是否是对象\n * @param {*} data\n */\nexport function isObject(data) {\n  return typeof data === \"object\" && data !== null;\n}\n\nexport const isArray = (val) => Array.isArray(val);\n\nexport const isSymbol = (val) => typeof val === \"symbol\";\n\nexport const hasOwn = (target, key) =>\n  Object.prototype.hasOwnProperty.call(target, key);\n\nexport const isIntegerKey = (key) => parseInt(key, 10) + \"\" === key;\n","import { isArray, isIntegerKey } from \"./util/index\";\n\nfunction effect(fn, options) {\n  const effect = createActiveEffect(fn, options);\n\n  if (!effect.lazy) {\n    // cleanupEffect(effect);\n    effect();\n  }\n  return effect;\n}\nlet effectStack = [];\nlet activeEffect;\nlet uid = 0;\n\nfunction createActiveEffect(fn, options) {\n  const effect = function reactiveEffect() {\n    effectStack.push(effect);\n    activeEffect = effect;\n    const result = fn();\n    effectStack.pop();\n    activeEffect = effectStack[effectStack.length - 1];\n    return result;\n  };\n  effect.id = uid++;\n  effect._isEffect = true;\n  effect.deps = [];\n  effect.options = options;\n  return effect;\n}\n\nlet targetMap = new WeakMap();\nexport function track(target, key) {\n  if (!activeEffect) return;\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key);\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n  if (!dep.has(activeEffect)) {\n    dep.add(activeEffect);\n    activeEffect.deps.push(dep);\n  }\n  console.log(targetMap);\n}\nexport function trigger(target, type, key, newValue, oldValue) {\n  let depsMap = targetMap.get(target);\n  if (!depsMap) return;\n  let deps = [];\n  if (isArray(target) && key === \"length\") {\n    //改变了数组的长度\n    depsMap.forEach((dep, key) => {\n      if (key === \"length\" || Number(key) > newValue) {\n        //  收集的依赖的下标大于新长度\n        deps.push(dep);\n      }\n    });\n  } else {\n    if (key !== void 0) {\n      const dep = depsMap.get(key);\n      if (dep) deps.push(dep);\n    }\n    //   新增数组的下标\n    if (type === \"add\" && isIntegerKey(key) && isArray(target)) {\n      deps.push(depsMap.get(\"length\"));\n    }\n    deps.forEach((dep) => {\n      [...dep].forEach((effect) => effect());\n    });\n  }\n}\n\nfunction cleanupEffect(effect) {\n  const { deps } = effect;\n  if (deps.length) {\n    for (let i = 0; i < deps.length; i++) {\n      deps[i].delete(effect);\n    }\n    deps.length = 0;\n  }\n}\n\nexport { effect };\n","import { track, trigger } from \"./effect\";\nimport { isObject, hasOwn, isArray, isIntegerKey } from \"./util/index\";\nexport function reactive(target) {\n  const proxy = new Proxy(target, {\n    get: function (target, key, receiver) {\n      track(target, key);\n      const res = Reflect.get(target, key, receiver);\n      if (isObject(res)) {\n        return reactive(res);\n      }\n      return res;\n    },\n    set: function (target, key, value, receiver) {\n      const oldValue = target[key];\n      const hadkey = //是否存在这个属性或下标\n        isArray(target) && isIntegerKey(key)\n          ? target.length > Number(key)\n          : hasOwn(target, key);\n\n      const res = Reflect.set(target, key, value, receiver);\n      if (!hadkey) {\n        trigger(target, \"add\", key, value, oldValue);\n      } else if (oldValue !== value) {\n        trigger(target, \"set\", key, value, oldValue);\n      }\n      return res;\n    },\n  });\n\n  return proxy;\n}\n","import { track, trigger } from \"./effect\";\nimport { reactive } from \"./reactive\";\nimport { isObject } from \"./util\";\n\nexport function ref(val) {\n  return createRef(val);\n}\nconst convert = (val) => (isObject(val) ? reactive(val) : val);\nfunction createRef(rawValue) {\n  let value = convert(rawValue);\n  const r = {\n    _v_isRef: true,\n    get value() {\n      track(r, \"value\");\n      return value;\n    },\n    set value(newValue) {\n      newValue = convert(newValue);\n      if (value !== newValue) {\n        value = newValue;\n        trigger(r, \"set\", \"value\", value);\n      }\n    },\n  };\n  return r;\n}\n\nexport function toRefs(target) {\n  const obj = {};\n  for (const key in target) {\n    if (Object.hasOwnProperty.call(target, key)) {\n      obj[key] = toRef(target, key);\n    }\n  }\n  return obj;\n}\n\nexport function toRef(obj, key) {\n  return {\n    _v_isRef: true,\n    get value() {\n      return obj[key];\n    },\n    set value(newValue) {\n      obj[key] = newValue;\n    },\n  };\n}\n"],"names":["isObject","data","isArray","val","Array","hasOwn","target","key","Object","prototype","hasOwnProperty","call","isIntegerKey","parseInt","effect","fn","options","createActiveEffect","lazy","effectStack","activeEffect","uid","reactiveEffect","push","result","pop","length","id","_isEffect","deps","targetMap","WeakMap","track","depsMap","get","set","Map","dep","Set","has","add","console","log","trigger","type","newValue","oldValue","forEach","Number","reactive","proxy","Proxy","receiver","res","Reflect","value","hadkey","ref","createRef","convert","rawValue","r","_v_isRef","toRefs","obj","toRef"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AAIO,SAASA,QAAT,CAAkBC,IAAlB,EAAwB;AAC7B,SAAO,QAAOA,IAAP,MAAgB,QAAhB,IAA4BA,IAAI,KAAK,IAA5C;AACD;AAEM,IAAMC,OAAO,GAAG,SAAVA,OAAU,CAACC,GAAD;AAAA,SAASC,KAAK,CAACF,OAAN,CAAcC,GAAd,CAAT;AAAA,CAAhB;AAIA,IAAME,MAAM,GAAG,SAATA,MAAS,CAACC,MAAD,EAASC,GAAT;AAAA,SACpBC,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCL,MAArC,EAA6CC,GAA7C,CADoB;AAAA,CAAf;AAGA,IAAMK,YAAY,GAAG,SAAfA,YAAe,CAACL,GAAD;AAAA,SAASM,QAAQ,CAACN,GAAD,EAAM,EAAN,CAAR,GAAoB,EAApB,KAA2BA,GAApC;AAAA,CAArB;;ACbP,SAASO,MAAT,CAAgBC,EAAhB,EAAoBC,OAApB,EAA6B;AAC3B,MAAMF,MAAM,GAAGG,kBAAkB,CAACF,EAAD,EAAKC,OAAL,CAAjC;;AAEA,MAAI,CAACF,MAAM,CAACI,IAAZ,EAAkB;AAChB;AACAJ,IAAAA,MAAM;AACP;;AACD,SAAOA,MAAP;AACD;;AACD,IAAIK,WAAW,GAAG,EAAlB;AACA,IAAIC,YAAJ;AACA,IAAIC,GAAG,GAAG,CAAV;;AAEA,SAASJ,kBAAT,CAA4BF,EAA5B,EAAgCC,OAAhC,EAAyC;AACvC,MAAMF,MAAM,GAAG,SAASQ,cAAT,GAA0B;AACvCH,IAAAA,WAAW,CAACI,IAAZ,CAAiBT,MAAjB;AACAM,IAAAA,YAAY,GAAGN,MAAf;AACA,QAAMU,MAAM,GAAGT,EAAE,EAAjB;AACAI,IAAAA,WAAW,CAACM,GAAZ;AACAL,IAAAA,YAAY,GAAGD,WAAW,CAACA,WAAW,CAACO,MAAZ,GAAqB,CAAtB,CAA1B;AACA,WAAOF,MAAP;AACD,GAPD;;AAQAV,EAAAA,MAAM,CAACa,EAAP,GAAYN,GAAG,EAAf;AACAP,EAAAA,MAAM,CAACc,SAAP,GAAmB,IAAnB;AACAd,EAAAA,MAAM,CAACe,IAAP,GAAc,EAAd;AACAf,EAAAA,MAAM,CAACE,OAAP,GAAiBA,OAAjB;AACA,SAAOF,MAAP;AACD;;AAED,IAAIgB,SAAS,GAAG,IAAIC,OAAJ,EAAhB;AACO,SAASC,KAAT,CAAe1B,MAAf,EAAuBC,GAAvB,EAA4B;AACjC,MAAI,CAACa,YAAL,EAAmB;AACnB,MAAIa,OAAO,GAAGH,SAAS,CAACI,GAAV,CAAc5B,MAAd,CAAd;;AACA,MAAI,CAAC2B,OAAL,EAAc;AACZH,IAAAA,SAAS,CAACK,GAAV,CAAc7B,MAAd,EAAuB2B,OAAO,GAAG,IAAIG,GAAJ,EAAjC;AACD;;AACD,MAAIC,GAAG,GAAGJ,OAAO,CAACC,GAAR,CAAY3B,GAAZ,CAAV;;AACA,MAAI,CAAC8B,GAAL,EAAU;AACRJ,IAAAA,OAAO,CAACE,GAAR,CAAY5B,GAAZ,EAAkB8B,GAAG,GAAG,IAAIC,GAAJ,EAAxB;AACD;;AACD,MAAI,CAACD,GAAG,CAACE,GAAJ,CAAQnB,YAAR,CAAL,EAA4B;AAC1BiB,IAAAA,GAAG,CAACG,GAAJ,CAAQpB,YAAR;AACAA,IAAAA,YAAY,CAACS,IAAb,CAAkBN,IAAlB,CAAuBc,GAAvB;AACD;;AACDI,EAAAA,OAAO,CAACC,GAAR,CAAYZ,SAAZ;AACD;AACM,SAASa,OAAT,CAAiBrC,MAAjB,EAAyBsC,IAAzB,EAA+BrC,GAA/B,EAAoCsC,QAApC,EAA8CC,QAA9C,EAAwD;AAC7D,MAAIb,OAAO,GAAGH,SAAS,CAACI,GAAV,CAAc5B,MAAd,CAAd;AACA,MAAI,CAAC2B,OAAL,EAAc;AACd,MAAIJ,IAAI,GAAG,EAAX;;AACA,MAAI3B,OAAO,CAACI,MAAD,CAAP,IAAmBC,GAAG,KAAK,QAA/B,EAAyC;AACvC;AACA0B,IAAAA,OAAO,CAACc,OAAR,CAAgB,UAACV,GAAD,EAAM9B,GAAN,EAAc;AAC5B,UAAIA,GAAG,KAAK,QAAR,IAAoByC,MAAM,CAACzC,GAAD,CAAN,GAAcsC,QAAtC,EAAgD;AAC9C;AACAhB,QAAAA,IAAI,CAACN,IAAL,CAAUc,GAAV;AACD;AACF,KALD;AAMD,GARD,MAQO;AACL,QAAI9B,GAAG,KAAK,KAAK,CAAjB,EAAoB;AAClB,UAAM8B,GAAG,GAAGJ,OAAO,CAACC,GAAR,CAAY3B,GAAZ,CAAZ;AACA,UAAI8B,GAAJ,EAASR,IAAI,CAACN,IAAL,CAAUc,GAAV;AACV,KAJI;;;AAML,QAAIO,IAAI,KAAK,KAAT,IAAkBhC,YAAY,CAACL,GAAD,CAA9B,IAAuCL,OAAO,CAACI,MAAD,CAAlD,EAA4D;AAC1DuB,MAAAA,IAAI,CAACN,IAAL,CAAUU,OAAO,CAACC,GAAR,CAAY,QAAZ,CAAV;AACD;;AACDL,IAAAA,IAAI,CAACkB,OAAL,CAAa,UAACV,GAAD,EAAS;AACpB,yBAAIA,GAAJ,EAASU,OAAT,CAAiB,UAACjC,MAAD;AAAA,eAAYA,MAAM,EAAlB;AAAA,OAAjB;AACD,KAFD;AAGD;AACF;;ACvEM,SAASmC,QAAT,CAAkB3C,MAAlB,EAA0B;AAC/B,MAAM4C,KAAK,GAAG,IAAIC,KAAJ,CAAU7C,MAAV,EAAkB;AAC9B4B,IAAAA,GAAG,EAAE,aAAU5B,MAAV,EAAkBC,GAAlB,EAAuB6C,QAAvB,EAAiC;AACpCpB,MAAAA,KAAK,CAAC1B,MAAD,EAASC,GAAT,CAAL;AACA,UAAM8C,GAAG,GAAGC,OAAO,CAACpB,GAAR,CAAY5B,MAAZ,EAAoBC,GAApB,EAAyB6C,QAAzB,CAAZ;;AACA,UAAIpD,QAAQ,CAACqD,GAAD,CAAZ,EAAmB;AACjB,eAAOJ,QAAQ,CAACI,GAAD,CAAf;AACD;;AACD,aAAOA,GAAP;AACD,KAR6B;AAS9BlB,IAAAA,GAAG,EAAE,aAAU7B,MAAV,EAAkBC,GAAlB,EAAuBgD,KAAvB,EAA8BH,QAA9B,EAAwC;AAC3C,UAAMN,QAAQ,GAAGxC,MAAM,CAACC,GAAD,CAAvB;AACA,UAAMiD,MAAM;AACVtD,MAAAA,OAAO,CAACI,MAAD,CAAP,IAAmBM,YAAY,CAACL,GAAD,CAA/B,GACID,MAAM,CAACoB,MAAP,GAAgBsB,MAAM,CAACzC,GAAD,CAD1B,GAEIF,MAAM,CAACC,MAAD,EAASC,GAAT,CAHZ;AAKA,UAAM8C,GAAG,GAAGC,OAAO,CAACnB,GAAR,CAAY7B,MAAZ,EAAoBC,GAApB,EAAyBgD,KAAzB,EAAgCH,QAAhC,CAAZ;;AACA,UAAI,CAACI,MAAL,EAAa;AACXb,QAAAA,OAAO,CAACrC,MAAD,EAAS,KAAT,EAAgBC,GAAhB,EAAqBgD,KAArB,CAAP;AACD,OAFD,MAEO,IAAIT,QAAQ,KAAKS,KAAjB,EAAwB;AAC7BZ,QAAAA,OAAO,CAACrC,MAAD,EAAS,KAAT,EAAgBC,GAAhB,EAAqBgD,KAArB,CAAP;AACD;;AACD,aAAOF,GAAP;AACD;AAvB6B,GAAlB,CAAd;AA0BA,SAAOH,KAAP;AACD;;AC1BM,SAASO,GAAT,CAAatD,GAAb,EAAkB;AACvB,SAAOuD,SAAS,CAACvD,GAAD,CAAhB;AACD;;AACD,IAAMwD,OAAO,GAAG,SAAVA,OAAU,CAACxD,GAAD;AAAA,SAAUH,QAAQ,CAACG,GAAD,CAAR,GAAgB8C,QAAQ,CAAC9C,GAAD,CAAxB,GAAgCA,GAA1C;AAAA,CAAhB;;AACA,SAASuD,SAAT,CAAmBE,QAAnB,EAA6B;AAC3B,MAAIL,KAAK,GAAGI,OAAO,CAACC,QAAD,CAAnB;AACA,MAAMC,CAAC,GAAG;AACRC,IAAAA,QAAQ,EAAE,IADF;;AAER,QAAIP,KAAJ,GAAY;AACVvB,MAAAA,KAAK,CAAC6B,CAAD,EAAI,OAAJ,CAAL;AACA,aAAON,KAAP;AACD,KALO;;AAMR,QAAIA,KAAJ,CAAUV,QAAV,EAAoB;AAClBA,MAAAA,QAAQ,GAAGc,OAAO,CAACd,QAAD,CAAlB;;AACA,UAAIU,KAAK,KAAKV,QAAd,EAAwB;AACtBU,QAAAA,KAAK,GAAGV,QAAR;AACAF,QAAAA,OAAO,CAACkB,CAAD,EAAI,KAAJ,EAAW,OAAX,EAAoBN,KAApB,CAAP;AACD;AACF;;AAZO,GAAV;AAcA,SAAOM,CAAP;AACD;;AAEM,SAASE,MAAT,CAAgBzD,MAAhB,EAAwB;AAC7B,MAAM0D,GAAG,GAAG,EAAZ;;AACA,OAAK,IAAMzD,GAAX,IAAkBD,MAAlB,EAA0B;AACxB,QAAIE,MAAM,CAACE,cAAP,CAAsBC,IAAtB,CAA2BL,MAA3B,EAAmCC,GAAnC,CAAJ,EAA6C;AAC3CyD,MAAAA,GAAG,CAACzD,GAAD,CAAH,GAAW0D,KAAK,CAAC3D,MAAD,EAASC,GAAT,CAAhB;AACD;AACF;;AACD,SAAOyD,GAAP;AACD;AAEM,SAASC,KAAT,CAAeD,GAAf,EAAoBzD,GAApB,EAAyB;AAC9B,SAAO;AACLuD,IAAAA,QAAQ,EAAE,IADL;;AAEL,QAAIP,KAAJ,GAAY;AACV,aAAOS,GAAG,CAACzD,GAAD,CAAV;AACD,KAJI;;AAKL,QAAIgD,KAAJ,CAAUV,QAAV,EAAoB;AAClBmB,MAAAA,GAAG,CAACzD,GAAD,CAAH,GAAWsC,QAAX;AACD;;AAPI,GAAP;AASD;;;;"}